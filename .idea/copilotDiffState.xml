<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/force-app/main/default/classes/discountCalculator/DiscountCalculatorHandler.cls">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/force-app/main/default/classes/discountCalculator/DiscountCalculatorHandler.cls" />
              <option name="originalContent" value="public with sharing class DiscountCalculatorHandler {&#10;    private class DiscountSettings {&#10;        public String strategy;&#10;        public Decimal maxDiscountPercent;&#10;&#10;        public DiscountSettings() {&#10;            List&lt;Discount_Settings__mdt&gt; settingsList = [&#10;                    SELECT Discount_Strategy__c, Max_Overall_Discount_Percentage__c&#10;                    FROM Discount_Settings__mdt&#10;                    LIMIT 1&#10;            ];&#10;            if (!settingsList.isEmpty()) {&#10;                Discount_Settings__mdt settings = settingsList[0];&#10;                this.strategy = settings.Discount_Strategy__c;&#10;                this.maxDiscountPercent = settings.Max_Overall_Discount_Percentage__c;&#10;            } else {&#10;                this.strategy = 'Highest';&#10;                this.maxDiscountPercent = 50.0;&#10;            }&#10;        }&#10;    }&#10;&#10;    public static void applyDiscounts(List&lt;Order&gt; newOrders) {&#10;&#10;        DiscountSettings settings = new DiscountSettings();&#10;&#10;        List&lt;Discount__c&gt; activeDiscounts = [SELECT Id, Name, Discount_Type__c, Value_Type__c, Discount_Value__c,&#10;                Start_Date__c, End_Date__c, Cron_Expression__c, Condition_Logic__c&#10;        FROM Discount__c WHERE Is_Active__c = true];&#10;&#10;        List&lt;Applied_Discount__c&gt; discountsToApply = new List&lt;Applied_Discount__c&gt;();&#10;&#10;        for (Order ord : newOrders) {&#10;            List&lt;Discount__c&gt; applicableDiscounts = findApplicableDiscounts(ord, activeDiscounts);&#10;&#10;            if (applicableDiscounts.isEmpty()) {&#10;                continue;&#10;            }&#10;&#10;            List&lt;Discount__c&gt; finalDiscounts = applyStrategy(applicableDiscounts, settings.strategy);&#10;            calculateAndAssignFinalDiscount(ord, finalDiscounts, settings, discountsToApply);&#10;        }&#10;        if (!discountsToApply.isEmpty()) {&#10;            insert discountsToApply;&#10;&#10;            updateTimesUsedCounter(discountsToApply);&#10;        }&#10;    }&#10;&#10;    private static List&lt;Discount__c&gt; findApplicableDiscounts(Order ord, List&lt;Discount__c&gt; activeDiscounts) {&#10;        List&lt;Discount__c&gt; matchedDiscounts = new List&lt;Discount__c&gt;();&#10;        Date today = Date.today();&#10;&#10;        for (Discount__c disc : activeDiscounts) {&#10;            Boolean isApplicable = false;&#10;            if (disc.Discount_Type__c == 'Time-Bound') {&#10;                if (disc.Start_Date__c &lt;= today &amp;&amp; disc.End_Date__c &gt;= today) {&#10;                    isApplicable = true;&#10;                }&#10;            } else if (disc.Discount_Type__c == 'Conditional') {&#10;                if (String.isNotBlank(disc.Condition_Logic__c) &amp;&amp; disc.Condition_Logic__c.contains('&gt;')) {&#10;                    List&lt;String&gt; parts = disc.Condition_Logic__c.split('&gt;');&#10;                    String fieldName = parts[0].trim().split('\\.')[1];&#10;                    Decimal value = Decimal.valueOf(parts[1].trim());&#10;&#10;                    if (ord.get(fieldName) != null &amp;&amp; (Decimal) ord.get(fieldName) &gt; value) {&#10;                        isApplicable = true;&#10;                    }&#10;                }&#10;            } else if (disc.Discount_Type__c == 'Recurring') {&#10;                if (isCronScheduledForToday(disc.Cron_Expression__c)) {&#10;                    isApplicable = true;&#10;                }&#10;            }&#10;&#10;            if (isApplicable) {&#10;                matchedDiscounts.add(disc);&#10;            }&#10;        }&#10;        return matchedDiscounts;&#10;    }&#10;&#10;    private static List&lt;Discount__c&gt; applyStrategy(List&lt;Discount__c&gt; applicableDiscounts, String strategy) {&#10;        if (applicableDiscounts.size() &lt;= 1) {&#10;            return applicableDiscounts;&#10;        }&#10;&#10;        List&lt;Discount__c&gt; finalDiscounts = new List&lt;Discount__c&gt;();&#10;&#10;        if (strategy == 'Combine') {&#10;            return applicableDiscounts;&#10;        } else if (strategy == 'Highest' || strategy == 'Lowest') {&#10;            Discount__c bestDiscount = applicableDiscounts[0];&#10;            for (Integer i = 1; i &lt; applicableDiscounts.size(); i++) {&#10;                if (strategy == 'Highest' &amp;&amp; applicableDiscounts[i].Discount_Value__c &gt; bestDiscount.Discount_Value__c) {&#10;                    bestDiscount = applicableDiscounts[i];&#10;                } else if (strategy == 'Lowest' &amp;&amp; applicableDiscounts[i].Discount_Value__c &lt; bestDiscount.Discount_Value__c) {&#10;                    bestDiscount = applicableDiscounts[i];&#10;                }&#10;            }&#10;            finalDiscounts.add(bestDiscount);&#10;        }&#10;        return finalDiscounts;&#10;    }&#10;    private static void calculateAndAssignFinalDiscount(Order ord, List&lt;Discount__c&gt; finalDiscounts, DiscountSettings settings, List&lt;Applied_Discount__c&gt; discountsToApply) {&#10;        Decimal totalDiscountAmount = 0;&#10;        Decimal originalOrderAmount = ord.TotalAmount == null ? 0 : ord.TotalAmount;&#10;&#10;        for (Discount__c disc : finalDiscounts) {&#10;            Decimal currentDiscountValue = 0;&#10;            if (disc.Value_Type__c == 'Percentage') {&#10;                currentDiscountValue = (originalOrderAmount * (disc.Discount_Value__c / 100)).setScale(2);&#10;            } else {&#10;                currentDiscountValue = disc.Discount_Value__c;&#10;            }&#10;            totalDiscountAmount += currentDiscountValue;&#10;            discountsToApply.add(new Applied_Discount__c(&#10;                    Order__c = ord.Id,&#10;                    Discount__c = disc.Id,&#10;                    Amount_Discounted__c = currentDiscountValue&#10;            ));&#10;        }&#10;&#10;        Decimal maxAllowedDiscount = originalOrderAmount * (settings.maxDiscountPercent / 100);&#10;        if (totalDiscountAmount &gt; maxAllowedDiscount) {&#10;            totalDiscountAmount = maxAllowedDiscount;&#10;        }&#10;        System.debug('Dla zamówienia ' + ord.Id + ' zastosowano zniżkę w wysokości: ' + totalDiscountAmount);&#10;    }&#10;&#10;    private static void updateTimesUsedCounter(List&lt;Applied_Discount__c&gt; applied) {&#10;        Map&lt;Id, Discount__c&gt; discountsToUpdate = new Map&lt;Id, Discount__c&gt;();&#10;        for (Applied_Discount__c ad : applied) {&#10;            if (!discountsToUpdate.containsKey(ad.Discount__c)) {&#10;                discountsToUpdate.put(ad.Discount__c, new Discount__c(Id = ad.Discount__c, Times_Used__c = 0));&#10;            }&#10;            Discount__c disc = discountsToUpdate.get(ad.Discount__c);&#10;            disc.Times_Used__c += 1;&#10;        }&#10;        update discountsToUpdate.values();&#10;    }&#10;&#10;    public static Boolean isCronScheduledForToday(String cron) {&#10;        if (String.isBlank(cron)) return false;&#10;        if (cron.contains(String.valueOf(Date.today().day()))) {&#10;            return true;&#10;        }&#10;        return false;&#10;    }&#10;}" />
              <option name="updatedContent" value="public with sharing class DiscountCalculatorHandler {&#10;    private class DiscountSettings {&#10;        public String strategy;&#10;        public Decimal maxDiscountPercent;&#10;&#10;        public DiscountSettings() {&#10;            List&lt;Discount_Settings__mdt&gt; settingsList = [&#10;                    SELECT Discount_Strategy__c, Max_Overall_Discount_Percentage__c&#10;                    FROM Discount_Settings__mdt&#10;                    LIMIT 1&#10;            ];&#10;            if (!settingsList.isEmpty()) {&#10;                Discount_Settings__mdt settings = settingsList[0];&#10;                this.strategy = settings.Discount_Strategy__c;&#10;                this.maxDiscountPercent = settings.Max_Overall_Discount_Percentage__c;&#10;            } else {&#10;                this.strategy = 'Highest';&#10;                this.maxDiscountPercent = 50.0;&#10;            }&#10;        }&#10;    }&#10;&#10;    public static Map&lt;Id, List&lt;Discount__c&gt;&gt; calculateDiscounts(List&lt;Order&gt; newOrders) {&#10;        DiscountSettings settings = new DiscountSettings();&#10;        List&lt;Discount__c&gt; activeDiscounts = [SELECT Id, Name, Discount_Type__c, Value_Type__c, Discount_Value__c,&#10;                Start_Date__c, End_Date__c, Cron_Expression__c, Condition_Logic__c&#10;        FROM Discount__c WHERE Is_Active__c = true];&#10;        Map&lt;Id, List&lt;Discount__c&gt;&gt; orderToDiscounts = new Map&lt;Id, List&lt;Discount__c&gt;&gt;();&#10;        for (Order ord : newOrders) {&#10;            List&lt;Discount__c&gt; applicableDiscounts = findApplicableDiscounts(ord, activeDiscounts);&#10;            if (applicableDiscounts.isEmpty()) {&#10;                continue;&#10;            }&#10;            List&lt;Discount__c&gt; finalDiscounts = applyStrategy(applicableDiscounts, settings.strategy);&#10;            orderToDiscounts.put(ord.Id, finalDiscounts);&#10;        }&#10;        return orderToDiscounts;&#10;    }&#10;&#10;    public static void applyDiscountsAfterInsert(List&lt;Order&gt; insertedOrders) {&#10;        DiscountSettings settings = new DiscountSettings();&#10;        List&lt;Discount__c&gt; activeDiscounts = [SELECT Id, Name, Discount_Type__c, Value_Type__c, Discount_Value__c,&#10;                Start_Date__c, End_Date__c, Cron_Expression__c, Condition_Logic__c&#10;        FROM Discount__c WHERE Is_Active__c = true];&#10;        List&lt;Applied_Discount__c&gt; discountsToApply = new List&lt;Applied_Discount__c&gt;();&#10;        for (Order ord : insertedOrders) {&#10;            List&lt;Discount__c&gt; applicableDiscounts = findApplicableDiscounts(ord, activeDiscounts);&#10;            if (applicableDiscounts.isEmpty()) {&#10;                continue;&#10;            }&#10;            List&lt;Discount__c&gt; finalDiscounts = applyStrategy(applicableDiscounts, settings.strategy);&#10;            calculateAndAssignFinalDiscount(ord, finalDiscounts, settings, discountsToApply);&#10;        }&#10;        if (!discountsToApply.isEmpty()) {&#10;            insert discountsToApply;&#10;            updateTimesUsedCounter(discountsToApply);&#10;        }&#10;    }&#10;&#10;    private static List&lt;Discount__c&gt; findApplicableDiscounts(Order ord, List&lt;Discount__c&gt; activeDiscounts) {&#10;        List&lt;Discount__c&gt; matchedDiscounts = new List&lt;Discount__c&gt;();&#10;        Date today = Date.today();&#10;&#10;        for (Discount__c disc : activeDiscounts) {&#10;            Boolean isApplicable = false;&#10;            if (disc.Discount_Type__c == 'Time-Bound') {&#10;                if (disc.Start_Date__c &lt;= today &amp;&amp; disc.End_Date__c &gt;= today) {&#10;                    isApplicable = true;&#10;                }&#10;            } else if (disc.Discount_Type__c == 'Conditional') {&#10;                if (String.isNotBlank(disc.Condition_Logic__c) &amp;&amp; disc.Condition_Logic__c.contains('&gt;')) {&#10;                    List&lt;String&gt; parts = disc.Condition_Logic__c.split('&gt;');&#10;                    String fieldName = parts[0].trim().split('\\.')[1];&#10;                    Decimal value = Decimal.valueOf(parts[1].trim());&#10;&#10;                    if (ord.get(fieldName) != null &amp;&amp; (Decimal) ord.get(fieldName) &gt; value) {&#10;                        isApplicable = true;&#10;                    }&#10;                }&#10;            } else if (disc.Discount_Type__c == 'Recurring') {&#10;                if (isCronScheduledForToday(disc.Cron_Expression__c)) {&#10;                    isApplicable = true;&#10;                }&#10;            }&#10;&#10;            if (isApplicable) {&#10;                matchedDiscounts.add(disc);&#10;            }&#10;        }&#10;        return matchedDiscounts;&#10;    }&#10;&#10;    private static List&lt;Discount__c&gt; applyStrategy(List&lt;Discount__c&gt; applicableDiscounts, String strategy) {&#10;        if (applicableDiscounts.size() &lt;= 1) {&#10;            return applicableDiscounts;&#10;        }&#10;&#10;        List&lt;Discount__c&gt; finalDiscounts = new List&lt;Discount__c&gt;();&#10;&#10;        if (strategy == 'Combine') {&#10;            return applicableDiscounts;&#10;        } else if (strategy == 'Highest' || strategy == 'Lowest') {&#10;            Discount__c bestDiscount = applicableDiscounts[0];&#10;            for (Integer i = 1; i &lt; applicableDiscounts.size(); i++) {&#10;                if (strategy == 'Highest' &amp;&amp; applicableDiscounts[i].Discount_Value__c &gt; bestDiscount.Discount_Value__c) {&#10;                    bestDiscount = applicableDiscounts[i];&#10;                } else if (strategy == 'Lowest' &amp;&amp; applicableDiscounts[i].Discount_Value__c &lt; bestDiscount.Discount_Value__c) {&#10;                    bestDiscount = applicableDiscounts[i];&#10;                }&#10;            }&#10;            finalDiscounts.add(bestDiscount);&#10;        }&#10;        return finalDiscounts;&#10;    }&#10;&#10;    private static void calculateAndAssignFinalDiscount(Order ord, List&lt;Discount__c&gt; finalDiscounts, DiscountSettings settings, List&lt;Applied_Discount__c&gt; discountsToApply) {&#10;        Decimal totalDiscountAmount = 0;&#10;        Decimal originalOrderAmount = ord.TotalAmount == null ? 0 : ord.TotalAmount;&#10;&#10;        for (Discount__c disc : finalDiscounts) {&#10;            Decimal currentDiscountValue = 0;&#10;            if (disc.Value_Type__c == 'Percentage') {&#10;                currentDiscountValue = (originalOrderAmount * (disc.Discount_Value__c / 100)).setScale(2);&#10;            } else {&#10;                currentDiscountValue = disc.Discount_Value__c;&#10;            }&#10;            totalDiscountAmount += currentDiscountValue;&#10;            discountsToApply.add(new Applied_Discount__c(&#10;                    Order__c = ord.Id,&#10;                    Discount__c = disc.Id,&#10;                    Amount_Discounted__c = currentDiscountValue&#10;            ));&#10;        }&#10;&#10;        Decimal maxAllowedDiscount = originalOrderAmount * (settings.maxDiscountPercent / 100);&#10;        if (totalDiscountAmount &gt; maxAllowedDiscount) {&#10;            totalDiscountAmount = maxAllowedDiscount;&#10;        }&#10;        System.debug('Dla zamówienia ' + ord.Id + ' zastosowano zniżkę w wysokości: ' + totalDiscountAmount);&#10;    }&#10;&#10;    private static void updateTimesUsedCounter(List&lt;Applied_Discount__c&gt; applied) {&#10;        Map&lt;Id, Discount__c&gt; discountsToUpdate = new Map&lt;Id, Discount__c&gt;();&#10;        for (Applied_Discount__c ad : applied) {&#10;            if (!discountsToUpdate.containsKey(ad.Discount__c)) {&#10;                discountsToUpdate.put(ad.Discount__c, new Discount__c(Id = ad.Discount__c, Times_Used__c = 0));&#10;            }&#10;            Discount__c disc = discountsToUpdate.get(ad.Discount__c);&#10;            disc.Times_Used__c += 1;&#10;        }&#10;        update discountsToUpdate.values();&#10;    }&#10;&#10;    public static Boolean isCronScheduledForToday(String cron) {&#10;        if (String.isBlank(cron)) return false;&#10;        if (cron.contains(String.valueOf(Date.today().day()))) {&#10;            return true;&#10;        }&#10;        return false;&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>